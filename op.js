!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).op=t()}(this,(function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function i(e){return"function"==typeof e}function r(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function s(e){e.parentNode.removeChild(e)}let a;function c(e){a=e}const l=[],u=[],d=[],f=[],h=Promise.resolve();let p=!1;function g(e){d.push(e)}let m=!1;const v=new Set;function w(){if(!m){m=!0;do{for(let e=0;e<l.length;e+=1){const t=l[e];c(t),x(t.$$)}for(c(null),l.length=0;u.length;)u.pop()();for(let e=0;e<d.length;e+=1){const t=d[e];v.has(t)||(v.add(t),t())}d.length=0}while(l.length);for(;f.length;)f.pop()();p=!1,m=!1,v.clear()}}function x(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(g)}}const y=new Set;function b(e,t){-1===e.$$.dirty[0]&&(l.push(e),p||(p=!0,h.then(w)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function E(r,l,u,d,f,h,p=[-1]){const m=a;c(r);const v=l.props||{},x=r.$$={fragment:null,ctx:null,props:h,update:e,not_equal:f,bound:n(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(m?m.$$.context:[]),callbacks:n(),dirty:p,skip_bound:!1};let E=!1;if(x.ctx=u?u(r,v,((e,t,...n)=>{const o=n.length?n[0]:t;return x.ctx&&f(x.ctx[e],x.ctx[e]=o)&&(!x.skip_bound&&x.bound[e]&&x.bound[e](o),E&&b(r,e)),t})):[],x.update(),E=!0,o(x.before_update),x.fragment=!!d&&d(x.ctx),l.target){if(l.hydrate){const e=(k=l.target,Array.from(k.childNodes));x.fragment&&x.fragment.l(e),e.forEach(s)}else x.fragment&&x.fragment.c();l.intro&&((S=r.$$.fragment)&&S.i&&(y.delete(S),S.i($))),function(e,n,r){const{fragment:s,on_mount:a,on_destroy:c,after_update:l}=e.$$;s&&s.m(n,r),g((()=>{const n=a.map(t).filter(i);c?c.push(...n):o(n),e.$$.on_mount=[]})),l.forEach(g)}(r,l.target,l.anchor),w()}var S,$,k;c(m)}var S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function $(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var k,M=$((function(e){!function(e,t,n){function o(e){var t,n=this,o=(t=4022871197,function(e){e=String(e);for(var n=0;n<e.length;n++){var o=.02519603282416938*(t+=e.charCodeAt(n));o-=t=o>>>0,t=(o*=t)>>>0,t+=4294967296*(o-=t)}return 2.3283064365386963e-10*(t>>>0)});n.next=function(){var e=2091639*n.s0+2.3283064365386963e-10*n.c;return n.s0=n.s1,n.s1=n.s2,n.s2=e-(n.c=0|e)},n.c=1,n.s0=o(" "),n.s1=o(" "),n.s2=o(" "),n.s0-=o(e),n.s0<0&&(n.s0+=1),n.s1-=o(e),n.s1<0&&(n.s1+=1),n.s2-=o(e),n.s2<0&&(n.s2+=1),o=null}function i(e,t){return t.c=e.c,t.s0=e.s0,t.s1=e.s1,t.s2=e.s2,t}function r(e,t){var n=new o(e),r=t&&t.state,s=n.next;return s.int32=function(){return 4294967296*n.next()|0},s.double=function(){return s()+11102230246251565e-32*(2097152*s()|0)},s.quick=s,r&&("object"==typeof r&&i(r,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=r:n&&n.amd?n((function(){return r})):this.alea=r}(0,e,!1)})),P=$((function(e){!function(e,t,n){function o(e){var t=this,n="";t.x=0,t.y=0,t.z=0,t.w=0,t.next=function(){var e=t.x^t.x<<11;return t.x=t.y,t.y=t.z,t.z=t.w,t.w^=t.w>>>19^e^e>>>8},e===(0|e)?t.x=e:n+=e;for(var o=0;o<n.length+64;o++)t.x^=0|n.charCodeAt(o),t.next()}function i(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}function r(e,t){var n=new o(e),r=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,r&&("object"==typeof r&&i(r,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=r:n&&n.amd?n((function(){return r})):this.xor128=r}(0,e,!1)})),H=$((function(e){!function(e,t,n){function o(e){var t=this,n="";t.next=function(){var e=t.x^t.x>>>2;return t.x=t.y,t.y=t.z,t.z=t.w,t.w=t.v,(t.d=t.d+362437|0)+(t.v=t.v^t.v<<4^e^e<<1)|0},t.x=0,t.y=0,t.z=0,t.w=0,t.v=0,e===(0|e)?t.x=e:n+=e;for(var o=0;o<n.length+64;o++)t.x^=0|n.charCodeAt(o),o==n.length&&(t.d=t.x<<10^t.x>>>4),t.next()}function i(e,t){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t.v=e.v,t.d=e.d,t}function r(e,t){var n=new o(e),r=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,r&&("object"==typeof r&&i(r,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=r:n&&n.amd?n((function(){return r})):this.xorwow=r}(0,e,!1)})),X=$((function(e){!function(e,t,n){function o(e){var t=this;t.next=function(){var e,n,o=t.x,i=t.i;return e=o[i],n=(e^=e>>>7)^e<<24,n^=(e=o[i+1&7])^e>>>10,n^=(e=o[i+3&7])^e>>>3,n^=(e=o[i+4&7])^e<<7,e=o[i+7&7],n^=(e^=e<<13)^e<<9,o[i]=n,t.i=i+1&7,n},function(e,t){var n,o=[];if(t===(0|t))o[0]=t;else for(t=""+t,n=0;n<t.length;++n)o[7&n]=o[7&n]<<15^t.charCodeAt(n)+o[n+1&7]<<13;for(;o.length<8;)o.push(0);for(n=0;n<8&&0===o[n];++n);for(8==n?o[7]=-1:o[n],e.x=o,e.i=0,n=256;n>0;--n)e.next()}(t,e)}function i(e,t){return t.x=e.x.slice(),t.i=e.i,t}function r(e,t){null==e&&(e=+new Date);var n=new o(e),r=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,r&&(r.x&&i(r,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=r:n&&n.amd?n((function(){return r})):this.xorshift7=r}(0,e,!1)})),O=$((function(e){!function(e,t,n){function o(e){var t=this;t.next=function(){var e,n,o=t.w,i=t.X,r=t.i;return t.w=o=o+1640531527|0,n=i[r+34&127],e=i[r=r+1&127],n^=n<<13,e^=e<<17,n^=n>>>15,e^=e>>>12,n=i[r]=n^e,t.i=r,n+(o^o>>>16)|0},function(e,t){var n,o,i,r,s,a=[],c=128;for(t===(0|t)?(o=t,t=null):(t+="\0",o=0,c=Math.max(c,t.length)),i=0,r=-32;r<c;++r)t&&(o^=t.charCodeAt((r+32)%t.length)),0===r&&(s=o),o^=o<<10,o^=o>>>15,o^=o<<4,o^=o>>>13,r>=0&&(s=s+1640531527|0,i=0==(n=a[127&r]^=o+s)?i+1:0);for(i>=128&&(a[127&(t&&t.length||0)]=-1),i=127,r=512;r>0;--r)o=a[i+34&127],n=a[i=i+1&127],o^=o<<13,n^=n<<17,o^=o>>>15,n^=n>>>12,a[i]=o^n;e.w=s,e.X=a,e.i=i}(t,e)}function i(e,t){return t.i=e.i,t.w=e.w,t.X=e.X.slice(),t}function r(e,t){null==e&&(e=+new Date);var n=new o(e),r=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,r&&(r.X&&i(r,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=r:n&&n.amd?n((function(){return r})):this.xor4096=r}(0,e,!1)})),_=$((function(e){!function(e,t,n){function o(e){var t=this,n="";t.next=function(){var e=t.b,n=t.c,o=t.d,i=t.a;return e=e<<25^e>>>7^n,n=n-o|0,o=o<<24^o>>>8^i,i=i-e|0,t.b=e=e<<20^e>>>12^n,t.c=n=n-o|0,t.d=o<<16^n>>>16^i,t.a=i-e|0},t.a=0,t.b=0,t.c=-1640531527,t.d=1367130551,e===Math.floor(e)?(t.a=e/4294967296|0,t.b=0|e):n+=e;for(var o=0;o<n.length+20;o++)t.b^=0|n.charCodeAt(o),t.next()}function i(e,t){return t.a=e.a,t.b=e.b,t.c=e.c,t.d=e.d,t}function r(e,t){var n=new o(e),r=t&&t.state,s=function(){return(n.next()>>>0)/4294967296};return s.double=function(){do{var e=((n.next()>>>11)+(n.next()>>>0)/4294967296)/(1<<21)}while(0===e);return e},s.int32=n.next,s.quick=s,r&&("object"==typeof r&&i(r,n),s.state=function(){return i(n,{})}),s}t&&t.exports?t.exports=r:n&&n.amd?n((function(){return r})):this.tychei=r}(0,e,!1)})),Y=(k=Object.freeze({__proto__:null,default:{}}))&&k.default||k,C=$((function(e){!function(t,n,o){var i,r=256,s=o.pow(r,6),a=o.pow(2,52),c=2*a,l=255;function u(e,l,u){var m=[],v=p(h((l=1==l?{entropy:!0}:l||{}).entropy?[e,g(n)]:null==e?function(){try{var e;return i&&(e=i.randomBytes)?e=e(r):(e=new Uint8Array(r),(t.crypto||t.msCrypto).getRandomValues(e)),g(e)}catch(e){var o=t.navigator,s=o&&o.plugins;return[+new Date,t,s,t.screen,g(n)]}}():e,3),m),w=new d(m),x=function(){for(var e=w.g(6),t=s,n=0;e<a;)e=(e+n)*r,t*=r,n=w.g(1);for(;e>=c;)e/=2,t/=2,n>>>=1;return(e+n)/t};return x.int32=function(){return 0|w.g(4)},x.quick=function(){return w.g(4)/4294967296},x.double=x,p(g(w.S),n),(l.pass||u||function(e,t,n,i){return i&&(i.S&&f(i,w),e.state=function(){return f(w,{})}),n?(o.random=e,t):e})(x,v,"global"in l?l.global:this==o,l.state)}function d(e){var t,n=e.length,o=this,i=0,s=o.i=o.j=0,a=o.S=[];for(n||(e=[n++]);i<r;)a[i]=i++;for(i=0;i<r;i++)a[i]=a[s=l&s+e[i%n]+(t=a[i])],a[s]=t;(o.g=function(e){for(var t,n=0,i=o.i,s=o.j,a=o.S;e--;)t=a[i=l&i+1],n=n*r+a[l&(a[i]=a[s=l&s+t])+(a[s]=t)];return o.i=i,o.j=s,n})(r)}function f(e,t){return t.i=e.i,t.j=e.j,t.S=e.S.slice(),t}function h(e,t){var n,o=[],i=typeof e;if(t&&"object"==i)for(n in e)try{o.push(h(e[n],t-1))}catch(e){}return o.length?o:"string"==i?e:e+"\0"}function p(e,t){for(var n,o=e+"",i=0;i<o.length;)t[l&i]=l&(n^=19*t[l&i])+o.charCodeAt(i++);return g(t)}function g(e){return String.fromCharCode.apply(0,e)}if(p(o.random(),n),e.exports){e.exports=u;try{i=Y}catch(e){}}else o.seedrandom=u}("undefined"!=typeof self?self:S,[],Math)}));C.alea=M,C.xor128=P,C.xorwow=H,C.xorshift7=X,C.xor4096=O,C.tychei=_;var j=C;const A=1,q=2,L=3,R=4,I=10;const z=new class{constructor(){this.log=[],this.sessionId=null,this.ws=null,this.seedrandom=null,this.mode=1,this.replicationHandlers=new Map,this.replicationEventListeners=new Map,this.clickHandlers=new Map,this.mouseDownHandlers=new Map,this.mouseUpHandlers=new Map,this.mouseMoveHandlers=new Map,this.gameInitFunction=null,this.gameReady=!1,this.lastClientNow=0,this.lastClientNowUpdateTime=0,this.passiveEventRegistry=new Map,this.replicationPaused=!1}initSession=(e,t)=>{console.log(`OP Arcade init session: ${t}`),this.sessionId=t;const n=`ws://${e}?sessionId=${this.sessionId}`;this.ws=new WebSocket(n),this.ws.onopen=e=>{console.log("WebSocket open:"),console.log(e),this.ws.onmessage=e=>{console.log("WebSocket message:"),console.log(e.data),"scoreSubmitted"===e.data&&this.refreshPage()}},this.ws.onerror=e=>{console.error("WebSocket error"),console.error(e)},this.serverSendQueue(),this.gameInitFunction&&(console.log("OP Arcade calling init game function."),this.gameInitFunction())};closeSession=()=>{this.mode=1,this.ws.close()};initGame=(e=null)=>{console.log("OP Arcade init game."),this.gameInitFunction=e,this.sessionId&&(console.log("OP Arcade calling init game function."),this.gameInitFunction())};postScore=async e=>window.postScoreHandler?await window.postScoreHandler(e):null;serverSendQueue=()=>{window.requestAnimationFrame(this.serverSendQueue),this.ws&&1===this.ws.readyState&&this.ws&&this.log.length>0&&(this.ws.send(JSON.stringify(this.log)),this.log.length=0)};replicate=async e=>{const t=e.e;if(9===t)return z.catchPassiveEvent(e.id,!0),!0;if(this.replicationPaused)return!1;e.t&&(this.lastClientNow=e.t,this.lastClientNowUpdateTime=window.performance.now());let n=null;if([A,q,L,R,I].includes(t)&&(n=this.replicationHandlers.get(t),!n))return!0;let o=null;if(8===t&&(o=this.findReplicationListenerHandler(e),!o))return console.error(`Handler for event ${t} not found!`),!0;switch(t){case 5:this.initSeedrandom(e.s);break;case A:n(e.t);break;case I:case q:case L:case R:n({clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY});break;case 8:o({target:document.getElementById(e.tid),type:e.type,keyCode:e.kc,preventDefault:()=>{},pageX:e.px,pageY:e.py,timeStamp:e.ts,ctrlKey:e.ck,button:e.b,movementX:e.mx,movementY:e.my})}return!0};startReplicating=()=>{this.mode=3};startPlay=(e,t)=>{1===this.mode&&(this.mode=2,this.sendEvent(7,{w:e,h:t}),this.initSeedrandom())};stopPlay=()=>{2===this.mode&&(this.mode=1,this.log=[])};sendEvent=(e,t)=>{if(2!==this.mode)return;const n={e:e,...t};n.t||(n.t=window.performance.now()),this.log.push(n)};setViewport=(e,t)=>{this.sendEvent(6,{w:e,h:t})};initSeedrandom=e=>{const t=e||Math.random().toString();this.seedrandom=new j(t),this.sendEvent(5,{s:t})};random=()=>this.seedrandom();requestAnimationFrame=e=>{if(3!==this.mode)return 2===this.mode?window.requestAnimationFrame((t=>{this.sendEvent(A,{t:t}),e(t)})):void 0;this.replicationHandlers.set(A,e)};addOnClick=(e,t)=>{if(3===this.mode)return void this.replicationHandlers.set(I,t);const n=e=>{this.sendEvent(I,{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY}),t(e)};e.onclick=n,this.addPerElementHandler(this.clickHandlers,e,n)};addOnMouseDown=(e,t)=>{if(3===this.mode)return void this.replicationHandlers.set(q,t);const n=e=>{this.sendEvent(q,{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY}),t(e)};e.onmousedown=n,this.addPerElementHandler(this.mouseDownHandlers,e,n)};addOnMouseUp=(e,t)=>{if(3===this.mode)return void this.replicationHandlers.set(L,t);const n=e=>{this.sendEvent(L,{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY}),t(e)};e.onmouseup=n,this.addPerElementHandler(this.mouseUpHandlers,e,n)};addOnMouseMove=(e,t)=>{if(console.log("addOnMouseMove"),3===this.mode)return void this.replicationHandlers.set(R,t);const n=e=>{this.sendEvent(R,{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY}),t(e)};e.onmousemove=n,this.addPerElementHandler(this.mouseMoveHandlers,e,n)};addPerElementHandler=(e,t,n)=>{let o=e.get(t);o||(o=[]),o.push(n),e.set(t,o)};addEventListener=(e,t,n)=>{if(3===this.mode)return void this.saveReplicationListenerHandler(e,t,n);e.addEventListener(t,(o=>{this.sendEvent(8,{t:o.type,oid:e.id||null,w:e===window,en:t,tid:o.target&&o.target.id||null,kc:o.keyCode,px:o.pageX,py:o.pageY,ts:o.timeStamp,ck:o.ctrlKey,b:o.button,mx:o.movementX,my:o.movementY}),n(o)}))};saveReplicationListenerHandler=(e,t,n)=>{this.replicationEventListeners.has(e)||this.replicationEventListeners.set(e,new Map);this.replicationEventListeners.get(e).set(t,n)};findReplicationListenerHandler=e=>{const t=e.w?window:document.getElementById(e.oid),n=this.replicationEventListeners.get(t);return n?n.get(e.en):null};refreshPage=()=>{setTimeout((()=>window.top.postMessage("refreshPage","*")),500)};now=()=>3===this.mode?this.lastClientNow+(window.performance.now()-this.lastClientNowUpdateTime):window.performance.now();firePassiveEvent=e=>{3!==this.mode?this.sendEvent(9,{id:e}):this.catchPassiveEvent(e,!1)};catchPassiveEvent=(e,t)=>{if(console.log(`catchPassiveEvent: ${e}, fromClient: ${t.toString()}`),this.passiveEventRegistry.has(e)){const n=this.passiveEventRegistry.get(e);t?n.client=!0:n.server=!0}else this.passiveEventRegistry.set(e,{client:t,server:!t});this.replicationPaused=[...this.passiveEventRegistry.entries()].some((([e,t])=>t.client&&!t.server)),console.log(`replicationPaused: ${this.replicationPaused.toString()}`)}},N=(e,t)=>z.initSession(e,t);var D=Object.freeze({__proto__:null,idleMode:1,playingMode:2,replicatingMode:3,initSession:N,initGame:e=>z.initGame(e),startPlay:(e,t)=>z.startPlay(e,t),stopPlay:()=>z.stopPlay(),setPostScoreHandler:e=>z.setPostScoreHandler(e),postScore:e=>z.postScore(e),setViewport:(e,t)=>z.setViewport(e,t),startReplicating:()=>z.startReplicating(),replicate:e=>z.replicate(e),random:()=>z.random(),requestAnimationFrame:e=>z.requestAnimationFrame(e),addOnClick:(e,t)=>z.addOnClick(e,t),addOnMouseDown:(e,t)=>z.addOnMouseDown(e,t),removeOnMouseDown:(e,t)=>{},addOnMouseUp:(e,t)=>z.addOnMouseUp(e,t),removeOnMouseUp:(e,t)=>{},addOnMouseMove:(e,t)=>z.addOnMouseMove(e,t),addEventListener:(e,t,n)=>z.addEventListener(e,t,n),now:()=>z.now(),firePassiveEvent:e=>z.firePassiveEvent(e)});function U(e,t,n){const o=["http://localhost:3000","http://test.outplay.games","http://alpha.outplay.games","http://op-arcade-dev.herokuapp.com","http://op-arcade-alpha.herokuapp.com","http://op-arcade-prod.herokuapp.com"];return window.addEventListener("message",(e=>{if(o.includes(e.origin))try{let t=JSON.parse(e.data);N(t.playServerUrl,t.playSessionId)}catch(e){console.log(e)}}),!1),[D]}let F=null;try{let e=document.getElementsByName("op-config")[0];null!=e&&(F=JSON.parse(e.content))}catch(e){console.log("unable to process op-config -- check if valid json")}const T=new class extends class{$destroy(){!function(e,t){const n=e.$$;null!==n.fragment&&(o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}(this,1),this.$destroy=e}$on(e,t){const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}{constructor(e){super(),E(this,e,U,null,r,{remotePlay:0})}get remotePlay(){return D}}({target:document.body,props:{config:F}});return window.op=T,T}));
//# sourceMappingURL=op.js.map
